<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="description" content="Calculateur de pertes de charge avec graphique interactif.">
    <meta name="theme-color" content="#0ea5e9">

    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Pertes de Charge App</title>

    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root { --safe-top: env(safe-area-inset-top); }
        body {
            overscroll-behavior-y: contain;
            padding-top: var(--safe-top);
            background-color: #f0f9ff;
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
        }
        input, select, button { min-height: 48px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- CONSTANTES MATÉRIAUX (hors composant pour éviter recréation) ---
        const MATERIAUX = {
            "Fonte neuve":               "0.26",
            "Fonte usagée":              "1.0",
            "PEHD (Polyéthylène)":       "0.007",
            "PVC / Plastique":           "0.0015",
            "Acier neuf":                "0.046",
            "Acier légèrement rouillé":  "0.25",
            "Acier très rouillé":        "1.0",
            "Béton lisse":               "0.3",
            "Béton brut":                "3.0",
            "Acier galvanisé":           "0.15",
            "Cuivre":                    "0.0015",
        };
        const DEFAULT_MATERIAU = "0.26";

        // --- FONCTION DE CALCUL PURE ---
        function calculatePDC(d_mm, l_m, q_m3h, k_mm) {
            const D = d_mm / 1000;
            const L = l_m;
            const Q = q_m3h / 3600;
            const k = k_mm / 1000;

            if (!D || !L || !Q || Q <= 0 || D <= 0) {
                return { perte: 0, vitesse: 0, unitaire: 0, Re: 0, regime: '-' };
            }

            const S = Math.PI * Math.pow(D / 2, 2);
            const V = Q / S;
            const nu = 1.004e-6;
            const Re = (V * D) / nu;

            let f;
            if (Re < 2300) {
                f = 64 / Re;
            } else {
                f = 0.25 / Math.pow(Math.log10((k / (3.7 * D)) + (5.74 / Math.pow(Re, 0.9))), 2);
            }

            const J = (f * L * Math.pow(V, 2)) / (2 * 9.81 * D);

            let regime;
            if (Re < 2300)      regime = 'Laminaire';
            else if (Re < 4000) regime = 'Transitoire';
            else                regime = 'Turbulent';

            return {
                vitesse: V,
                perte: J,
                unitaire: (J / L) * 1000,
                Re: Math.round(Re),
                regime
            };
        }

        // --- COMPOSANT CARTE TRONÇON ---
        function TronconCard({ troncon, index, total, onUpdate, onRemove, resultat }) {
            const V = resultat ? resultat.vitesse : null;

            let alerteBadge = null;
            if (V !== null) {
                if (V < 0.5) {
                    alerteBadge = (
                        <span className="inline-block bg-orange-100 text-orange-700 border border-orange-300 text-[10px] font-bold px-2 py-0.5 rounded-full">
                            ⚠ Vitesse faible — risque de dépôts
                        </span>
                    );
                } else if (V > 3) {
                    alerteBadge = (
                        <span className="inline-block bg-red-100 text-red-700 border border-red-300 text-[10px] font-bold px-2 py-0.5 rounded-full">
                            ⚠ Vitesse élevée — risque d'érosion
                        </span>
                    );
                }
            }

            const regimeColor =
                !resultat ? '' :
                resultat.regime === 'Laminaire'   ? 'text-green-600' :
                resultat.regime === 'Transitoire' ? 'text-orange-500' :
                                                    'text-sky-600';

            return (
                <div className="bg-white rounded-3xl p-5 shadow-lg border border-slate-100 space-y-4">
                    <div className="flex items-center justify-between">
                        <h3 className="text-sm font-black text-sky-600 uppercase tracking-wide">
                            Tronçon {index + 1}
                        </h3>
                        {total > 1 && (
                            <button
                                onClick={onRemove}
                                className="w-8 h-8 flex items-center justify-center bg-red-50 text-red-400 rounded-full hover:bg-red-100 active:scale-95 transition-all text-xl font-bold leading-none"
                                aria-label="Supprimer ce tronçon"
                            >
                                ×
                            </button>
                        )}
                    </div>

                    <div>
                        <label className="text-xs font-bold text-sky-600 uppercase ml-2">Matériau (Rugosité k)</label>
                        <select
                            className="w-full bg-slate-50 border-0 rounded-2xl px-4 py-3 mt-1 focus:ring-2 focus:ring-sky-500 outline-none"
                            value={troncon.materiau}
                            onChange={e => onUpdate('materiau', e.target.value)}
                        >
                            {Object.entries(MATERIAUX).map(([nom, val]) => (
                                <option key={nom} value={val}>{nom} — [k = {val} mm]</option>
                            ))}
                        </select>
                    </div>

                    <div className="grid grid-cols-2 gap-3">
                        <div>
                            <label className="text-xs font-bold text-slate-500 uppercase ml-2">Ø Int (mm)</label>
                            <input
                                type="number" inputMode="decimal" placeholder="110"
                                value={troncon.diametre}
                                className="w-full bg-slate-50 border-0 rounded-2xl px-4 py-3 mt-1 focus:ring-2 focus:ring-sky-500 outline-none"
                                onChange={e => onUpdate('diametre', e.target.value)}
                            />
                        </div>
                        <div>
                            <label className="text-xs font-bold text-slate-500 uppercase ml-2">Long (m)</label>
                            <input
                                type="number" inputMode="decimal" placeholder="100"
                                value={troncon.longueur}
                                className="w-full bg-slate-50 border-0 rounded-2xl px-4 py-3 mt-1 focus:ring-2 focus:ring-sky-500 outline-none"
                                onChange={e => onUpdate('longueur', e.target.value)}
                            />
                        </div>
                    </div>

                    {resultat && (
                        <div className="bg-slate-50 rounded-2xl p-4 space-y-3">
                            {alerteBadge && <div>{alerteBadge}</div>}
                            <div className="grid grid-cols-2 gap-2 text-sm">
                                <div className="bg-white rounded-xl p-3">
                                    <p className="text-[10px] text-slate-400 uppercase tracking-wider">Perte</p>
                                    <p className="font-black text-slate-800">{resultat.perte.toFixed(3)} <span className="text-xs font-normal text-slate-500">mCE</span></p>
                                </div>
                                <div className="bg-white rounded-xl p-3">
                                    <p className="text-[10px] text-slate-400 uppercase tracking-wider">Vitesse</p>
                                    <p className="font-black text-slate-800">{resultat.vitesse.toFixed(2)} <span className="text-xs font-normal text-slate-500">m/s</span></p>
                                </div>
                                <div className="bg-white rounded-xl p-3">
                                    <p className="text-[10px] text-slate-400 uppercase tracking-wider">Reynolds</p>
                                    <p className="font-black text-slate-800">{resultat.Re.toLocaleString('fr-FR')}</p>
                                </div>
                                <div className="bg-white rounded-xl p-3">
                                    <p className="text-[10px] text-slate-400 uppercase tracking-wider">Régime</p>
                                    <p className={`font-black text-sm ${regimeColor}`}>{resultat.regime}</p>
                                </div>
                            </div>
                            <p className="text-[10px] text-slate-400 text-right">{resultat.unitaire.toFixed(2)} mm/m (linéaire)</p>
                        </div>
                    )}
                </div>
            );
        }

        // --- COMPOSANT RÉSULTAT TOTAL ---
        function ResultatTotal({ resultats, debit }) {
            return (
                <div className="bg-slate-800 rounded-3xl p-6 text-white shadow-xl">
                    <h3 className="text-xs font-bold uppercase tracking-widest text-slate-400 mb-4">Récapitulatif réseau série</h3>
                    <div className="flex justify-between items-center border-b border-slate-600 pb-4 mb-4">
                        <span className="text-sm opacity-80">Perte de charge totale</span>
                        <span className="text-3xl font-black text-sky-300">
                            {resultats.perteTotal.toFixed(3)} <span className="text-lg font-medium">mCE</span>
                        </span>
                    </div>
                    <div className="grid grid-cols-3 gap-3 text-sm">
                        <div className="bg-slate-700/50 p-3 rounded-xl">
                            <p className="text-[10px] opacity-60 uppercase tracking-wider">Débit</p>
                            <p className="text-base font-bold">{parseFloat(debit).toFixed(1)} m³/h</p>
                        </div>
                        <div className="bg-slate-700/50 p-3 rounded-xl">
                            <p className="text-[10px] opacity-60 uppercase tracking-wider">Tronçons</p>
                            <p className="text-base font-bold">{resultats.parTroncon.length}</p>
                        </div>
                        <div className="bg-slate-700/50 p-3 rounded-xl">
                            <p className="text-[10px] opacity-60 uppercase tracking-wider">Linéaire moy.</p>
                            <p className="text-base font-bold">
                                {(resultats.parTroncon.reduce((s, r) => s + r.unitaire, 0) / resultats.parTroncon.length).toFixed(1)} mm/m
                            </p>
                        </div>
                    </div>
                </div>
            );
        }

        // --- COMPOSANT GRAPHIQUE ---
        function ChartComponent({ troncons, debit }) {
            const canvasRef = useRef(null);
            const chartRef = useRef(null);
            const tronconsSig = troncons.map(t => `${t.diametre}-${t.longueur}-${t.materiau}`).join('|');

            useEffect(() => {
                const ctx = canvasRef.current.getContext('2d');
                if (chartRef.current) { chartRef.current.destroy(); }

                const maxDebit = parseFloat(debit) * 1.5 || 10;
                const steps = 30;
                const labels = [];
                const dataPoints = [];

                for (let i = 0; i <= steps; i++) {
                    const q = (maxDebit / steps) * i;
                    labels.push(q.toFixed(1));
                    if (q === 0) { dataPoints.push(0); continue; }

                    const perteTotal = troncons.reduce((sum, t) => {
                        const r = calculatePDC(
                            parseFloat(t.diametre),
                            parseFloat(t.longueur),
                            q,
                            parseFloat(t.materiau)
                        );
                        return sum + r.perte;
                    }, 0);
                    dataPoints.push(perteTotal.toFixed(3));
                }

                chartRef.current = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels,
                        datasets: [{
                            label: 'Perte totale (mCE)',
                            data: dataPoints,
                            borderColor: '#0ea5e9',
                            backgroundColor: 'rgba(14, 165, 233, 0.1)',
                            borderWidth: 3,
                            pointRadius: 0,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { title: { display: true, text: 'Débit (m³/h)' } },
                            y: { title: { display: true, text: 'Perte totale (mCE)' }, beginAtZero: true }
                        }
                    }
                });

                return () => { if (chartRef.current) { chartRef.current.destroy(); } };
            }, [tronconsSig, debit]);

            return (
                <div className="bg-white rounded-3xl p-4 shadow-xl border border-slate-100 mt-4 h-64">
                    <h3 className="text-sm font-bold text-slate-700 mb-2 uppercase text-center italic">Courbe de perte de charge — réseau complet</h3>
                    <div className="h-full pb-6">
                        <canvas ref={canvasRef}></canvas>
                    </div>
                </div>
            );
        }

        // --- COMPOSANT PRINCIPAL APP ---
        function App() {
            const nextId = useRef(2);
            const [troncons, setTroncons] = useState([
                { id: 1, materiau: DEFAULT_MATERIAU, diametre: '', longueur: '' }
            ]);
            const [debit, setDebit] = useState('');
            const [deferredPrompt, setDeferredPrompt] = useState(null);

            useEffect(() => {
                window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); setDeferredPrompt(e); });
            }, []);

            const addTroncon = () => {
                setTroncons(prev => [...prev, { id: nextId.current++, materiau: DEFAULT_MATERIAU, diametre: '', longueur: '' }]);
            };

            const removeTroncon = (id) => setTroncons(prev => prev.filter(t => t.id !== id));

            const updateTroncon = (id, field, value) =>
                setTroncons(prev => prev.map(t => t.id === id ? { ...t, [field]: value } : t));

            const resultats = useMemo(() => {
                const Q = parseFloat(debit);
                if (!Q || Q <= 0) return null;
                const allFilled = troncons.every(t => parseFloat(t.diametre) > 0 && parseFloat(t.longueur) > 0);
                if (!allFilled) return null;

                const parTroncon = troncons.map(t => ({
                    id: t.id,
                    ...calculatePDC(parseFloat(t.diametre), parseFloat(t.longueur), Q, parseFloat(t.materiau))
                }));
                return { parTroncon, perteTotal: parTroncon.reduce((s, r) => s + r.perte, 0) };
            }, [troncons, debit]);

            return (
                <div className="max-w-md mx-auto p-4 min-h-screen pb-24">
                    <header className="text-center py-6">
                        <img src="icon.png" alt="Logo" className="w-20 h-20 mx-auto mb-2 rounded-2xl shadow-md" />
                        <h1 className="text-2xl font-black text-slate-800 tracking-tight">CALCULATEUR PDC</h1>
                    </header>

                    {/* Débit global */}
                    <div className="bg-white rounded-3xl px-6 py-5 shadow-xl border border-slate-100 mb-5">
                        <label className="text-xs font-bold text-sky-600 uppercase ml-2">Débit global (m³/h)</label>
                        <input
                            type="number" inputMode="decimal" placeholder="25"
                            value={debit}
                            className="w-full bg-slate-50 border-0 rounded-2xl px-4 py-3 mt-1 focus:ring-2 focus:ring-sky-500 outline-none"
                            onChange={e => setDebit(e.target.value)}
                        />
                    </div>

                    {/* Liste des tronçons */}
                    <div className="space-y-4">
                        {troncons.map((t, index) => (
                            <TronconCard
                                key={t.id}
                                troncon={t}
                                index={index}
                                total={troncons.length}
                                onUpdate={(field, value) => updateTroncon(t.id, field, value)}
                                onRemove={() => removeTroncon(t.id)}
                                resultat={resultats ? resultats.parTroncon.find(r => r.id === t.id) : null}
                            />
                        ))}
                    </div>

                    {/* Bouton ajouter */}
                    <button
                        onClick={addTroncon}
                        className="w-full mt-4 border-2 border-dashed border-sky-300 text-sky-600 font-bold py-4 rounded-2xl hover:bg-sky-50 active:scale-95 transition-all text-sm"
                    >
                        + Ajouter un tronçon
                    </button>

                    {/* Résultats */}
                    {resultats && (
                        <>
                            <div className="mt-6">
                                <ResultatTotal resultats={resultats} debit={debit} />
                            </div>

                            <ChartComponent troncons={troncons} debit={debit} />

                            <div className="mt-4 bg-blue-100/50 border border-blue-200 rounded-2xl p-4 text-[11px] text-blue-900 leading-relaxed shadow-sm">
                                <h4 className="font-bold uppercase mb-2 flex items-center gap-2">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                                    Paramètres de calcul
                                </h4>
                                <ul className="space-y-1 opacity-90">
                                    <li>• <strong>Loi :</strong> Darcy-Weisbach (Friction : Swamee-Jain)</li>
                                    <li>• <strong>Fluide :</strong> Eau à 20°C (ν = 1.004 × 10⁻⁶ m²/s)</li>
                                    <li>• <strong>Laminaire</strong> si Re &lt; 2 300 → f = 64/Re</li>
                                    <li>• <strong>Réseau série</strong> — même débit dans tous les tronçons</li>
                                </ul>
                            </div>
                        </>
                    )}

                    {deferredPrompt && (
                        <div className="fixed bottom-4 left-4 right-4 bg-white p-4 rounded-2xl shadow-2xl border-2 border-sky-500 flex items-center justify-between z-50">
                            <div className="flex items-center space-x-3">
                                <img src="icon.png" alt="icon" className="w-10 h-10 rounded-lg" />
                                <p className="font-bold text-slate-800 text-sm">Installer l'app</p>
                            </div>
                            <button onClick={() => { deferredPrompt.prompt(); setDeferredPrompt(null); }} className="bg-sky-600 text-white font-bold px-4 py-2 rounded-xl text-xs">INSTALLER</button>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js').catch(() => {}));
        }
    </script>
</body>
</html>
