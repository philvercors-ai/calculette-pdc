<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="description" content="Calculateur de pertes de charge avec graphique interactif.">
    <meta name="theme-color" content="#0ea5e9">
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Pertes de Charge App</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root { --safe-top: env(safe-area-inset-top); }
        body { 
            overscroll-behavior-y: contain; 
            padding-top: var(--safe-top);
            background-color: #f0f9ff;
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
        }
        input, select, button { min-height: 48px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- FONCTION DE CALCUL PURE ---
        function calculatePDC(d_mm, l_m, q_m3h, k_mm) {
            const D = d_mm / 1000;
            const L = l_m;
            const Q = q_m3h / 3600;
            const k = k_mm / 1000;

            if (!D || !L || !Q || Q <= 0) return { perte: 0, vitesse: 0, unitaire: 0 };

            const S = Math.PI * Math.pow(D / 2, 2);
            const V = Q / S;
            const nu = 1.004e-6; // Viscosité eau 20°C
            const Re = (V * D) / nu;
            
            let f = 0.25 / Math.pow(Math.log10((k / (3.7 * D)) + (5.74 / Math.pow(Re, 0.9))), 2);
            if (Re < 2300) { f = 64 / Re; }

            const J = (f * L * Math.pow(V, 2)) / (2 * 9.81 * D);

            return {
                vitesse: V,
                perte: J,
                unitaire: (J / L) * 1000
            };
        }

        // --- COMPOSANT GRAPHIQUE ---
        function ChartComponent({ diametre, longueur, materiau, currentDebit }) {
            const canvasRef = useRef(null);
            const chartRef = useRef(null);

            useEffect(() => {
                const ctx = canvasRef.current.getContext('2d');
                if (chartRef.current) { chartRef.current.destroy(); }

                const dataPoints = [];
                const labels = [];
                const maxDebit = parseFloat(currentDebit) * 1.5 || 10;
                const steps = 20;

                for (let i = 0; i <= steps; i++) {
                    const q = (maxDebit / steps) * i;
                    if (q === 0) {
                        dataPoints.push(0);
                        labels.push(0);
                        continue;
                    }
                    const res = calculatePDC(parseFloat(diametre), parseFloat(longueur), q, parseFloat(materiau));
                    dataPoints.push(res.perte.toFixed(2));
                    labels.push(q.toFixed(1));
                }

                chartRef.current = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Perte (mCE)',
                            data: dataPoints,
                            borderColor: '#0ea5e9',
                            backgroundColor: 'rgba(14, 165, 233, 0.1)',
                            borderWidth: 3,
                            pointRadius: 0,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { title: { display: true, text: 'Débit (m³/h)' } },
                            y: { title: { display: true, text: 'Perte (mCE)' }, beginAtZero: true }
                        }
                    }
                });

                return () => { if (chartRef.current) { chartRef.current.destroy(); } };
            }, [diametre, longueur, materiau, currentDebit]);

            return (
                <div className="bg-white rounded-3xl p-4 shadow-xl border border-slate-100 mt-6 h-64">
                    <h3 className="text-sm font-bold text-slate-700 mb-2 uppercase text-center italic">Courbe de perte de charge</h3>
                    <div className="h-full pb-6">
                        <canvas ref={canvasRef}></canvas>
                    </div>
                </div>
            );
        }

        // --- COMPOSANT PRINCIPAL APP ---
        function App() {
            const [values, setValues] = useState({ diametre: '', longueur: '', debit: '', materiau: '0.26' });
            const [res, setRes] = useState(null);
            const [deferredPrompt, setDeferredPrompt] = useState(null);

            const materiaux = {
                "Fonte neuve": "0.26",
                "Fonte usagée": "1.0",
                "PEHD (Polyéthylène)": "0.007",
                "PVC / Plastique": "0.0015",
                "Acier neuf": "0.046",
                "Acier légèrement rouillé": "0.25",
                "Acier très rouillé": "1.0",                
                "Béton lisse": "0.3",
                "Béton brut": "3.0",
                "Acier galvanisé": "0.15",
                "Cuivre": "0.0015",
            };

            useEffect(() => {
                window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); setDeferredPrompt(e); });
            }, []);

            const handleCalculate = () => {
                if (!values.diametre || !values.longueur || !values.debit) return alert("Veuillez remplir tous les champs");
                const calculated = calculatePDC(parseFloat(values.diametre), parseFloat(values.longueur), parseFloat(values.debit), parseFloat(values.materiau));
                setRes({
                    vitesse: calculated.vitesse.toFixed(2),
                    perte: calculated.perte.toFixed(2),
                    unitaire: calculated.unitaire.toFixed(2)
                });
            };

            return (
                <div className="max-w-md mx-auto p-4 min-h-screen pb-24">
                    <header className="text-center py-6">
                        <img src="icon.png" alt="Logo" className="w-20 h-20 mx-auto mb-2 rounded-2xl shadow-md" />
                        <h1 className="text-2xl font-black text-slate-800 tracking-tight">CALCULATEUR PDC</h1>
                    </header>

                    <main className="bg-white rounded-3xl p-6 shadow-xl border border-slate-100 space-y-5 relative z-10">
                        <div className="space-y-4">
                            <div>
                                <label className="text-xs font-bold text-sky-600 uppercase ml-2">Matériau (Rugosité k)</label>
                                <select 
                                    className="w-full bg-slate-50 border-0 rounded-2xl px-4 py-3 mt-1 focus:ring-2 focus:ring-sky-500 outline-none" 
                                    value={values.materiau}
                                    onChange={e => setValues({...values, materiau: e.target.value})}
                                >
                                    {Object.entries(materiaux).map(([n, v]) => (
                                        <option key={n} value={v}>
                                            {n} — [k = {v} mm]
                                        </option>
                                    ))}
                                </select>
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="text-xs font-bold text-slate-500 uppercase ml-2">Ø Int (mm)</label>
                                    <input type="number" placeholder="110" className="w-full bg-slate-50 border-0 rounded-2xl px-4 py-3 mt-1 focus:ring-2 focus:ring-sky-500 outline-none" onChange={e => setValues({...values, diametre: e.target.value})} />
                                </div>
                                <div>
                                    <label className="text-xs font-bold text-slate-500 uppercase ml-2">Long (m)</label>
                                    <input type="number" placeholder="100" className="w-full bg-slate-50 border-0 rounded-2xl px-4 py-3 mt-1 focus:ring-2 focus:ring-sky-500 outline-none" onChange={e => setValues({...values, longueur: e.target.value})} />
                                </div>
                            </div>
                            <div>
                                <label className="text-xs font-bold text-slate-500 uppercase ml-2">Débit (m³/h)</label>
                                <input type="number" placeholder="25" className="w-full bg-slate-50 border-0 rounded-2xl px-4 py-3 mt-1 focus:ring-2 focus:ring-sky-500 outline-none" onChange={e => setValues({...values, debit: e.target.value})} />
                            </div>
                        </div>

                        <button onClick={handleCalculate} className="w-full bg-gradient-to-r from-sky-500 to-blue-600 text-white font-bold py-4 rounded-2xl shadow-lg shadow-sky-200 active:scale-95 transition-all text-lg">
                            CALCULER
                        </button>
                    </main>

                    {res && (
                        <>
                            <div className="mt-6 bg-slate-800 rounded-3xl p-6 text-white shadow-xl relative z-0">
                                <div className="flex justify-between items-center border-b border-slate-600 pb-3 mb-3">
                                    <span className="text-sm opacity-80 font-medium">Perte de charge totale</span>
                                    <span className="text-3xl font-black text-sky-300">{res.perte} mCE</span>
                                </div>
                                <div className="grid grid-cols-2 gap-4 text-sm font-medium">
                                    <div className="bg-slate-700/50 p-3 rounded-xl">
                                        <p className="text-[10px] opacity-70 uppercase tracking-wider">Vitesse</p>
                                        <p className="text-lg">{res.vitesse} m/s</p>
                                    </div>
                                    <div className="bg-slate-700/50 p-3 rounded-xl">
                                        <p className="text-[10px] opacity-70 uppercase tracking-wider">Linéaire</p>
                                        <p className="text-lg">{res.unitaire} mm/m</p>
                                    </div>
                                </div>
                            </div>

                            <ChartComponent 
                                diametre={values.diametre} 
                                longueur={values.longueur} 
                                materiau={values.materiau}
                                currentDebit={values.debit}
                            />

                            <div className="mt-6 bg-blue-100/50 border border-blue-200 rounded-2xl p-4 text-[11px] text-blue-900 leading-relaxed shadow-sm">
                                <h4 className="font-bold uppercase mb-2 flex items-center gap-2">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                                    Paramètres de calcul
                                </h4>
                                <ul className="space-y-1 opacity-90">
                                    <li>• <strong>Loi :</strong> Darcy-Weisbach (Friction : Swamee-Jain)</li>
                                    <li>• <strong>Fluide :</strong> Eau à 20°C (Viscosité : 1.004 × 10⁻⁶ m²/s)</li>
                                    <li>• <strong>Rugosité ($k$) :</strong> {values.materiau} mm</li>
                                </ul>
                            </div>
                        </>
                    )}

                    {deferredPrompt && (
                        <div className="fixed bottom-4 left-4 right-4 bg-white p-4 rounded-2xl shadow-2xl border-2 border-sky-500 flex items-center justify-between z-50">
                            <div className="flex items-center space-x-3">
                                <img src="icon.png" alt="icon" className="w-10 h-10 rounded-lg" />
                                <p className="font-bold text-slate-800 text-sm">Installer l'app</p>
                            </div>
                            <button onClick={() => { deferredPrompt.prompt(); setDeferredPrompt(null); }} className="bg-sky-600 text-white font-bold px-4 py-2 rounded-xl text-xs">INSTALLER</button>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js').catch(() => {}));
        }
    </script>
</body>
</html>